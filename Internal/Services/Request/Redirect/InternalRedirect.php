<?php namespace ZN\Services\Request;

use CallController, URL, Session, IS;

class InternalRedirect extends CallController implements InternalRedirectInterface
{
    //--------------------------------------------------------------------------------------------------------
    //
    // Author     : Ozan UYKUN <ozanbote@gmail.com>
    // Site       : www.znframework.com
    // License    : The MIT License
    // Copyright  : (c) 2012-2016, znframework.com
    //
    //--------------------------------------------------------------------------------------------------------

    //--------------------------------------------------------------------------------------------------------
    // Fix
    //--------------------------------------------------------------------------------------------------------
    //
    // @var string = 'redirect:'
    //
    //--------------------------------------------------------------------------------------------------------
    protected $fix = 'redirect:';

    //--------------------------------------------------------------------------------------------------------
    // $redirect
    //--------------------------------------------------------------------------------------------------------
    //
    // @var array
    //
    //--------------------------------------------------------------------------------------------------------
    protected $redirect =
    [
        'time'   => 0,
        'data'   => []
    ];

    //--------------------------------------------------------------------------------------------------------
    // Status -> 4.3.5
    //--------------------------------------------------------------------------------------------------------
    //
    // @param void
    //
    //--------------------------------------------------------------------------------------------------------
    public function status() : Int
    {
        return server('redirectStatus');
    }

    //--------------------------------------------------------------------------------------------------------
    // Url -> 4.3.5
    //--------------------------------------------------------------------------------------------------------
    //
    // @param void
    //
    //--------------------------------------------------------------------------------------------------------
    public function url() : String
    {
        return server('redirectUrl');
    }

    //--------------------------------------------------------------------------------------------------------
    // Query String -> 4.3.5
    //--------------------------------------------------------------------------------------------------------
    //
    // @param void
    //
    //--------------------------------------------------------------------------------------------------------
    public function queryString() : String
    {
        return server('redirectQueryString');
    }

    //--------------------------------------------------------------------------------------------------
    // redirect() -> 5.1.0
    //--------------------------------------------------------------------------------------------------
    //
    // @param string $url
    // @param int    $time
    // @param array  $data
    // @param bool   $exit
    //
    //--------------------------------------------------------------------------------------------------
    public function location(String $url = NULL, Int $time = 0, Array $data = NULL, Bool $exit = true)
    {
        if( ! IS::url((string) $url) )
        {
            $url = URL::site($url);
        }

        if( ! empty($data) )
        {
            foreach( $data as $k => $v )
            {
                Session::insert($this->fix . $k, $v);
            }
        }

        if( $time > 0 )
        {
            sleep($time);
        }

        header('Location: ' . $url, true);

        if( $exit === true )
        {
            exit;
        }
    }

    //--------------------------------------------------------------------------------------------------
    // redirectData() -> 5.1.0
    //--------------------------------------------------------------------------------------------------
    //
    // @param string $k
    //
    // @return mixed
    //
    //--------------------------------------------------------------------------------------------------
    public function selectData(String $k)
    {
        if( $data = Session::select($this->fix . $k) )
        {
            return $data;
        }
        else
        {
            return false;
        }
    }

    //--------------------------------------------------------------------------------------------------
    // redirectDeleteData() -> 5.1.0
    //--------------------------------------------------------------------------------------------------
    //
    // @param mixed $data
    //
    // @return bool
    //
    //--------------------------------------------------------------------------------------------------
    public function deleteData($data) : Bool
    {
        if( is_array($data) ) foreach( $data as $v )
        {
            Session::delete($this->fix . $v);
        }
        else
        {
            return Session::delete($this->fix . $data);
        }

        return true;
    }

    //--------------------------------------------------------------------------------------------------------
    // action()
    //--------------------------------------------------------------------------------------------------------
    //
    // @var string $action
    //
    //--------------------------------------------------------------------------------------------------------
    public function action(String $action)
    {
        $time = $this->redirect['time'];
        $data = $this->redirect['data'];

        $this->redirect = [];

        return $this->location($action, $time, $data);
    }

    //--------------------------------------------------------------------------------------------------------
    // time()
    //--------------------------------------------------------------------------------------------------------
    //
    // @var numeric $time
    //
    //--------------------------------------------------------------------------------------------------------
    public function time(Int $time = 0) : InternalRedirect
    {
        $this->redirect['time'] = $time;

        return $this;
    }

    //--------------------------------------------------------------------------------------------------------
    // wait()
    //--------------------------------------------------------------------------------------------------------
    //
    // @var numeric $time
    //
    //--------------------------------------------------------------------------------------------------------
    public function wait(Int $time = 0) : InternalRedirect
    {
        $this->redirect['time'] = $time;

        return $this;
    }

    //--------------------------------------------------------------------------------------------------------
    // data()
    //--------------------------------------------------------------------------------------------------------
    //
    // @var array $data
    //
    //--------------------------------------------------------------------------------------------------------
    public function data(Array $data) : InternalRedirect
    {
        $this->redirect['data'] = $data;

        return $this;
    }

    //--------------------------------------------------------------------------------------------------------
    // insert()
    //--------------------------------------------------------------------------------------------------------
    //
    // @var array $data
    //
    //--------------------------------------------------------------------------------------------------------
    public function insert(Array $data) : InternalRedirect
    {
        $this->redirect['data'] = $data;

        return $this;
    }

    //--------------------------------------------------------------------------------------------------------
    // select()
    //--------------------------------------------------------------------------------------------------------
    //
    // @var string $key
    //
    //--------------------------------------------------------------------------------------------------------
    public function select(String $key)
    {
        return $this->selectData($key);
    }

    //--------------------------------------------------------------------------------------------------------
    // delete()
    //--------------------------------------------------------------------------------------------------------
    //
    // @var mixed $key
    //
    //--------------------------------------------------------------------------------------------------------
    public function delete($key) : Bool
    {
        return $this->deleteData($key);
    }
}
